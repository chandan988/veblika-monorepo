version: '3.8'

services:
  # Backend Assist API - Express + TypeScript + Socket.IO
  backend-assist-api:
    build:
      context: .
      dockerfile: apps/backend-assist-api/Dockerfile
    container_name: backend-assist-api
    ports:
      - "8000:8000"
    environment:
      - NODE_ENV=production
      - PORT=8000
      - MONGODB_URI=${BA_MONGODB_URI}
      - API_PREFIX=/api/v1
      - CORS_ORIGIN=http://backend-assist-web:3000,http://widget-ui:80
      - CLIENT_URL=${BA_CLIENT_URL}
      - BETTER_AUTH_URL=${BA_BETTER_AUTH_URL}
      - BETTER_AUTH_SECRET=${BA_BETTER_AUTH_SECRET}
      - DEFAULT_FROM_EMAIL=${BA_DEFAULT_FROM_EMAIL}
      - SMTP_HOST=${BA_SMTP_HOST}
      - SMTP_PORT=${BA_SMTP_PORT}
      - SMTP_USER=${BA_SMTP_USER}
      - SMTP_PASS=${BA_SMTP_PASS}
      - GOOGLE_CLIENT_ID=${BA_GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${BA_GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URI=${BA_GOOGLE_REDIRECT_URI}
      - GMAIL_PUBSUB_TOPIC=${BA_GMAIL_PUBSUB_TOPIC}
    restart: unless-stopped
    networks:
      - veblika-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Backend Assist Web - Next.js Frontend
  backend-assist-web:
    build:
      context: .
      dockerfile: apps/backend-assist-web/Dockerfile
    container_name: backend-assist-web
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_AUTH_URL=http://localhost:8000
      - NEXT_PUBLIC_CLIENT_URL=http://localhost:3000
    depends_on:
      backend-assist-api:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - veblika-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Social Media API - Express + MongoDB
  social-media-api:
    build:
      context: .
      dockerfile: apps/social-media-api/Dockerfile
    container_name: social-media-api
    ports:
      - "8001:8001"
    environment:
      - NODE_ENV=production
      - PORT=8001
      - MONGO_URL=${SM_MONGO_URL}
      - JWT_SECRET=${SM_JWT_SECRET}
      - AWS_REGION=${SM_AWS_REGION}
      - BUCKETNAME=${SM_BUCKETNAME}
      - S3ACCESSKEYID=${SM_S3ACCESSKEYID}
      - S3ACCESSKEY=${SM_S3ACCESSKEY}
      - S3_ENDPOINT=${SM_S3_ENDPOINT}
      - META_APP_ID=${SM_META_APP_ID}
      - META_APP_SECRET=${SM_META_APP_SECRET}
      - INSTAGRAM_APP_ID=${SM_INSTAGRAM_APP_ID}
      - INSTAGRAM_APP_SECRET=${SM_INSTAGRAM_APP_SECRET}
      - INSTAGRAM_REDIRECT_URI=${SM_INSTAGRAM_REDIRECT_URI}
      - FACEBOOK_REDIRECT_URI=${SM_FACEBOOK_REDIRECT_URI}
      - LINKEDIN_CLIENT_ID=${SM_LINKEDIN_CLIENT_ID}
      - LINKEDIN_CLIENT_SECRET=${SM_LINKEDIN_CLIENT_SECRET}
      - LINKEDIN_REDIRECT_URI=${SM_LINKEDIN_REDIRECT_URI}
      - GOOGLE_CLIENT_ID=${SM_YOUTUBE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${SM_YOUTUBE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URI=${SM_YOUTUBE_REDIRECT_URI}
      - FRONTEND_URL=${SM_FRONTEND_URL}
    restart: unless-stopped
    networks:
      - veblika-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Social Media Web - Next.js Frontend
  social-media-web:
    build:
      context: .
      dockerfile: apps/social-media-web/Dockerfile
    container_name: social-media-web
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_CLIENT_URL=http://localhost:3001
      - NEXT_PUBLIC_AUTH_URL=http://localhost:8000
      - NEXT_PUBLIC_API_URL=http://localhost:8001
    depends_on:
      backend-assist-api:
        condition: service_healthy
      social-media-api:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - veblika-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Widget UI - Vite + React with Nginx
  widget-ui:
    build:
      context: .
      dockerfile: apps/widget-ui/Dockerfile
      args:
        - VITE_BACKEND_API_URL=http://localhost:8000
    container_name: widget-ui
    ports:
      - "5173:80"
    depends_on:
      backend-assist-api:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - veblika-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  veblika-network:
    driver: bridge

# Optional: Add volumes for logs or persistent data
volumes:
  api-logs:
  web-logs:
